# Сервис работы с зашифрованной базой данных

Этот модуль реализует сервис для работы с зашифрованной базой данных SQLite с использованием SQLCipher и библиотеки Drift.

## Основные компоненты

### 1. Модели данных (`models/database_metadata.dart`)
- `DatabaseMetadata` - модель для хранения метаданных базы данных
- `DatabaseMetadataTable` - таблица Drift для хранения метаданных

### 2. База данных (`database/credentials_database.dart`)
- `CredentialsDatabase` - основной класс для работы с зашифрованной БД
- Singleton паттерн для управления подключением
- Автоматическая блокировка по таймауту (15 минут)
- Шифрование с помощью SQLCipher

### 3. Сервисный слой (`services/credentials_service.dart`)
- `CredentialsService` - высокоуровневый API для работы с БД
- Интеграция с системой ошибок приложения
- Автоблокировка при сворачивании окна
- Управление таймерами неактивности

### 4. Демо-страница (`demo/credentials_demo_page.dart`)
- Пример использования сервиса
- UI для тестирования всех функций

## Основные функции

### Управление базой данных
- ✅ **Создание БД** - создание новой зашифрованной базы данных
- ✅ **Открытие БД** - открытие существующей БД с паролем
- ✅ **Закрытие БД** - корректное закрытие подключения
- ✅ **Блокировка БД** - немедленная блокировка доступа

### Автоматическая блокировка
- ✅ **По таймауту** - автоблокировка через 15 минут неактивности
- ✅ **При сворачивании** - блокировка при сворачивании окна приложения
- ✅ **При закрытии** - корректное закрытие при выходе из приложения

### Работа с метаданными
- ✅ **Создание записи** - добавление новых метаданных БД
- ✅ **Чтение всех записей** - получение списка всех БД
- ✅ **Обновление времени** - отслеживание последнего открытия
- ✅ **Изменение статуса** - управление блокировкой записей
- ✅ **Удаление записи** - удаление метаданных

### Безопасность
- ✅ **Хеширование паролей** - SHA-256 хеширование
- ✅ **Проверка паролей** - безопасная проверка
- ✅ **Шифрование данных** - SQLCipher для шифрования файла БД

### Интеграция с системой ошибок
- ✅ **Типизированные ошибки** - использование `DatabaseError`
- ✅ **Уровни критичности** - правильная категоризация ошибок
- ✅ **Детальная информация** - подробности об ошибках для отладки

## Использование

```dart
// Инициализация сервиса
final credentialsService = CredentialsService.instance;
await credentialsService.initialize();

// Открытие базы данных
try {
  await credentialsService.openDatabase('my_password');
  print('База данных открыта успешно');
} catch (e) {
  print('Ошибка: $e');
}

// Создание метаданных
final metadata = await credentialsService.createDatabaseMetadata(
  name: 'Моя БД',
  description: 'Описание базы данных',
  password: 'my_password',
);

// Получение всех метаданных
final allDatabases = await credentialsService.getAllDatabaseMetadata();

// Закрытие базы данных
await credentialsService.closeDatabase();
```

## Технические детали

### Зависимости
- `drift` - ORM для работы с SQLite
- `sqlcipher_flutter_libs` - шифрование базы данных
- `crypto` - хеширование паролей
- `window_manager` - управление окном приложения
- `path_provider` - получение путей к файлам

### Структура таблицы метаданных
- `id` - уникальный идентификатор (автоинкремент)
- `name` - имя базы данных (1-255 символов)
- `description` - описание (до 1000 символов)
- `passwordHash` - хеш пароля (SHA-256)
- `createdAt` - время создания
- `lastOpenedAt` - время последнего открытия
- `isLocked` - статус блокировки

### Особенности реализации
- Singleton паттерн для CredentialsDatabase
- Автоматическое управление таймерами
- Интеграция с системой окон для Windows/Linux/macOS
- Graceful shutdown при закрытии приложения

## Следующие шаги

Для полной функциональности рекомендуется:

1. **Запустить build_runner** для генерации кода:
   ```bash
   dart run build_runner build --delete-conflicting-outputs
   ```

2. **Добавить демо-страницу в роутинг** приложения

3. **Настроить интеграцию** с основной системой ошибок

4. **Протестировать** все функции на разных платформах

## Безопасность

⚠️ **Важные моменты безопасности:**
- Пароли никогда не хранятся в открытом виде
- Используется сильное шифрование SQLCipher
- Автоматическая блокировка предотвращает несанкционированный доступ
- Корректная очистка памяти при закрытии БД
